<!DOCTYPE html>
<html lang="en">
<head>

<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1"/>
<meta name="natural history" content="netrc"/>
<title> natural history </title>

<link  href="http://fonts.googleapis.com/css?family=Syncopate:regular,bold" rel="stylesheet" type="text/css" />

<style type="text/css">
body {
	background-color: #A0A0A0;
}

.nhKingdom {
  font-weight: bold;
}
.nhGenus {
  font-weight: bold;
  font-style: italic;
}
.nhNote {
  font-style: italic;
}

@media all and (min-width: 28em) {
  .ui-input-text  {
    box-sizing: none !important;
    -moz-box-sizing: none !important;
    -webkit-box-sizing: none !important;
    width: 100% !important;
    display: inline-block !important;
  }
}
</style>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

<link href="skin-win8/ui.fancytree.css" rel="stylesheet" type="text/css">
<script src="jquery.fancytree.js" type="text/javascript"></script>
<script src="https://cdn.firebase.com/js/client/2.2.5/firebase.js"></script>

<script type="text/javascript">
  // https://github.com/mar10/fancytree
  // http://wwwendt.de/tech/fancytree/demo/
  // https://github.com/mar10/fancytree/wiki
  // http://wwwendt.de/tech/fancytree/doc/jsdoc/global.html#FancytreeOptions

  var NH = ["Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Specie"];

  // Converts firebase tree (and recursively subtree) into a fancytree tree obj
  // 
  // fancytree is a tree with properties title, key, and children
  //    - the "title" is html snippet containing taxon, common, and comment
  // n - the firebase data tree or subtree
  // k - the (recursive) level #, for finding the taxon category
  // ta - array of parent titles, for generating key name
  function convertToFT2( n, k, ta ) {
    var r = [];
    for (var i in n) {
      var e = {};
      var kta = ta.slice();  // need fresh ta for each pass through loop
      var logStr = i + " ";
      var wPre = "";
      var wPost="";
      if (n[i].hasOwnProperty("_link")) {
        logStr += "_w " + n[i]['_link'] + " ";
        wPre = '<a href="' + n[i]['_link'] + '"> ';
        wPost = '</a> ';
        e['xlink'] = n[i]['_link'];
        delete n[i]['_link'];
      };
      kta.push(i);
      e['title'] = NH[k] +": "+  wPre + i + wPost;
      e['xtitle'] = i;
      e['key'] = kta.join("/");
      if (n[i].hasOwnProperty("_common")) {
        logStr += "_c " + n[i]['_common'] + " ";
        e['title'] += "<i> " + n[i]['_common']+ " </i>";
        e['xcommon'] = n[i]['_common'];
        delete n[i]['_common'];
      };
      if (n[i].hasOwnProperty("_comment")) {
        logStr += "_m " + n[i]['_comment'] + " ";
        e['title'] += " -  " + n[i]['_comment'];
        e['xcomment'] = n[i]['_comment'];
        delete n[i]['_comment'];
      };
      console.log("c2 logStr: " + logStr);
      // we've deleted text props from n[i], 
      //    so next for loop will just do subtrees if any
      var rt = convertToFT2(n[i], k+1,kta);   
      if (rt.length > 0) {
        e['children'] = rt;
      }
      r.push(e);
    }
    return r;
  };

  // I don't think I much care if you logged in; firebase will handle this
  function authHandler(error, authData) {
    if (error) {
      console.log("Login Failed!", error);
    } else {
      console.log("Authenticated successfully with payload:", authData);
    }
  }

  function addChild( fbRef ) {
    var authData = fbRef.getAuth();
    if (authData) {
      console.log("add child, user: " + authData.uid + " logged in via " + authData.provider);
    } else {
      console.log("add child, not logged in !");
      //https://www.firebase.com/docs/web/guide/login/google.html
      // maybe check auth if/when asked to edit
      fbRef.authWithOAuthPopup("google", authHandler);
      console.log("hmmmm... are we logged in?");
      var authData = fbRef.getAuth();
      if (authData) {
        console.log("got logged in! user: " + authData.uid + " logged in via " + authData.provider);
       } else {
        console.log("drat noot logged in !");
      }
    }
    var p = $("#nh").fancytree("getActiveNode");
    if ( p ) {
      console.log("parent: " + p.title);
      console.log("parent key: " + p.key);
      var nchild = { // grab vals via jq 
        title : $("#add_title").val(),
        name : $("#add_common").val(),
        link : $("#add_link").val(),
        comment : $("#add_comment").val()
      };
      console.log("vals: " + nchild.title + " " + nchild.name);
      p.addChildren( { title: nchild.title } );  // waste of time; redrawn
      var ntObject = {};
      ntObject[ nchild.title ] = {};
      if (nchild.name && nchild.name != "") {
        ntObject[ nchild.title ]["_common"] = nchild.name;
      }
      if (nchild.link && nchild.link != "") {
        ntObject[ nchild.title ]["_link"] = nchild.link;
      }
      if (nchild.comment && nchild.comment != "") {
        ntObject[ nchild.title ]["_comment"] = nchild.comment;
      }
      var addHere = fbRef.child(p.key);
      addHere.update( ntObject, function(err) {
        if (err) { console.log("update of "+nchild.title+" failed: "+err );
        } else { console.log("ok update of "+nchild.title );
        } 
      } );
    } else {
      alert("please select a node to which to add");
    };
  }
 
  $(document).ready(function() {
    var fbRef = new Firebase("https://netrc-nathistory.firebaseio.com");
    fbRef.child('tree').on("value", function(snapshot) {
      var treeData = snapshot.val(); 
      var nhFancyTree = convertToFT2( treeData, 0, ['tree'] );

      $("#nh").fancytree({source: nhFancyTree});
      $("#nh").fancytree("getRootNode").visit(function(node){ node.setExpanded(true); });


      var dialog;
      dialog = $( "#addchild-form" ).dialog({
        autoOpen: false,
        height: 400,
        width: 650,
        modal: true,
        buttons: [
          { text:"Add child...", 
            click: function(){ 
              addChild(fbRef);
              dialog.dialog( "close" );
            } 
          },
          { text: "Cancel",
            click: function() {
              dialog.dialog( "close" );
            }
         }
        ],
        close: function() {
          //form[ 0 ].reset();
          //allFields.removeClass( "ui-state-error" );
          console.log("dialog cancel");
        }
     } );
     $("#AddChild").button().on('click', function(event) {
       dialog.dialog("open");
     } );
     $("#addchild-form").on("dialogopen", function() {
       var p = $("#nh").fancytree("getActiveNode");
       if ( p ) {
         console.log("add dialog open set title to: " + p.key);
         $("#addchild-label").html(p.key);
       }
     } );
     $("#EditChild").button().on('click', function(event) {
       var p = $("#nh").fancytree("getActiveNode");
       if ( ! p ) {
         alert("Please select item to edit...");
         return;
       }
       console.log("edit dialog open set title to: " + p.key);
       $("#addchild-label").html(p.key);
       dialog.dialog('option', 'title', 'Editing...');
       // set up new defaults
       $("#add_title").val(p.data.xtitle);
       $("#add_common").val(p.data.xcommon);
       $("#add_link").val(p.data.xlink);
       $("#add_comment").val(p.data.xcomment);
       dialog.dialog("open");
     } );
    });

  });
</script>
</head>

<body>

<h2> Natural History of 7 Byron Road </h2>

<div id="nh">
</div>
<hr>
<button id="AddChild"> Add Child </button>
<button id="EditChild"> Edit Node </button>

<div id="addchild-form" title="Add child">
  <label id="addchild-label"></label>
  <form>
    <fieldset>
      <label for="name">Name</label>
      <input type="text" name="title" id="add_title" value="taxonomic name" class="text ui-widget-content ui-corner-all">
      <p>
      <label for="email">Common name</label>
      <input type="text" name="common" id="add_common" value="name" class="text ui-widget-content ui-corner-all">
      <p>
      <label for="password">Link</label>
      <input type="text" name="link" id="add_link" value="http://" class="text ui-widget-content ui-corner-all" width="300">
      <p>
      <label for="comment">Comment</label>
      <input type="text" name="comment" id="add_comment" value="" class="text ui-widget-content ui-corner-all">
      <p>
 
      <!-- Allow form submission with keyboard without duplicating the dialog button -->
      <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
    </fieldset>
  </form>
</div>
</body>

</html>
